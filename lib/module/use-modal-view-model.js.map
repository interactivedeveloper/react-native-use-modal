{"version":3,"sources":["use-modal-view-model.tsx"],"names":["useCallback","useEffect","useImperativeHandle","useMemo","useState","BehaviorSubject","firstValueFrom","Subject","filter","first","ModalResultType","useModalViewModel","ref","cancelOnBackButtonPress","cancelOnBackdropPress","desiredVisibility","setDesiredVisibility","result$","visibility$","param","setParam","visibility","setVisibility","value","subscription","subscribe","unsubscribe","show","_param","next","confirm","data","pipe","type","CONFIRM","cancel","CANCEL","handleBackdropPress","handleBackButtonPress","handleModalShown","handleModalHidden"],"mappings":"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","sourcesContent":["import {\n  MutableRefObject,\n  useCallback,\n  useEffect,\n  useImperativeHandle,\n  useMemo,\n  useState,\n} from 'react';\nimport { BehaviorSubject, firstValueFrom, Subject } from 'rxjs';\nimport { filter, first } from 'rxjs/operators';\nimport type { ModalInstance } from './modal-instance';\nimport type { ModalResult } from './modal-result';\nimport type { ModalConfirmFunction } from './modal-confirm-function';\nimport { ModalResultType } from './modal-result-type';\n\ntype ModalVisibility = 'HIDDEN' | 'SHOWN';\n\nexport const useModalViewModel = <\n  Data extends unknown = void, // 모달 결과로 받을 값의 타입\n  Param extends unknown = void\n>(\n  ref:\n    | ((instance: ModalInstance<Data, Param> | null) => void)\n    | MutableRefObject<ModalInstance<Data, Param> | null>\n    | null,\n  {\n    cancelOnBackButtonPress = false,\n    cancelOnBackdropPress = false,\n  }: {\n    cancelOnBackdropPress?: boolean; // 배경 클릭시 취소 여부\n    cancelOnBackButtonPress?: boolean; // 뒤로가기 버튼 클릭시 취소 여부\n  } = {}\n) => {\n  // desired 표시 상태 (이 값이 true 라고 해서 모달이 표시된 상태는 아닙니다. false 도 마찬가지)\n  const [desiredVisibility, setDesiredVisibility] = useState(false);\n  // AlertResult Subject\n  const [result$] = useState(() => new Subject<ModalResult<Data>>());\n  // 보여짐/숨겨짐 상태\n  const [visibility$] = useState(\n    () => new BehaviorSubject<ModalVisibility>('HIDDEN')\n  );\n  const [param, setParam] = useState<Param>();\n  const [visibility, setVisibility] = useState<ModalVisibility>(\n    visibility$.value\n  );\n\n  useEffect(() => {\n    const subscription = visibility$.subscribe((value) => {\n      setVisibility(value);\n    });\n    return () => subscription.unsubscribe();\n  }, [visibility$]);\n\n  useImperativeHandle(\n    ref,\n    () => ({\n      // @ts-ignore\n      show: (_param: Param) => {\n        setParam(_param);\n        // 모달 표시 상태로 변경 시작\n        setDesiredVisibility(true);\n        visibility$.next('SHOWN');\n        // 모달 결과 Subject 에서\n        return firstValueFrom(result$);\n      },\n    }),\n    [result$, visibility$]\n  );\n\n  // 모달 종료 (승인)\n  const confirm = useCallback<ModalConfirmFunction<Data>>(\n    // @ts-ignore\n    (data) => {\n      // 숨김 상태로 변경 시작\n      setDesiredVisibility(false);\n      // 숨김 상태로 변경되면 result 발행\n      visibility$\n        .pipe(\n          filter((value) => value === 'HIDDEN'),\n          first()\n        )\n        .subscribe(() => {\n          result$.next({\n            type: ModalResultType.CONFIRM,\n            // @ts-ignore\n            data,\n          });\n        });\n    },\n    [result$, visibility$]\n  );\n\n  // 모달 종료 (취소)\n  const cancel = useCallback(() => {\n    // 숨김 상태로 변경 시작\n    setDesiredVisibility(false);\n    // 숨김 상태로 변경되면 result 발행\n    visibility$\n      .pipe(\n        filter((value) => value === 'HIDDEN'),\n        first()\n      )\n      .subscribe(() => {\n        result$.next({\n          type: ModalResultType.CANCEL,\n        });\n      });\n  }, [result$, visibility$]);\n\n  // 배경 클릭 핸들\n  const handleBackdropPress = useCallback(() => {\n    cancelOnBackdropPress && cancel();\n  }, [cancel, cancelOnBackdropPress]);\n\n  // 뒤로가기 버튼 클릭 핸들\n  const handleBackButtonPress = useCallback(() => {\n    cancelOnBackButtonPress && cancel();\n  }, [cancel, cancelOnBackButtonPress]);\n\n  // 모달 보여짐 이벤트 핸들\n  const handleModalShown = useCallback(() => {\n    visibility$.next('SHOWN');\n  }, [visibility$]);\n\n  // 모달 숨겨짐 이벤트 핸들\n  const handleModalHidden = useCallback(() => {\n    visibility$.next('HIDDEN');\n  }, [visibility$]);\n\n  return useMemo(\n    () => ({\n      confirm,\n      cancel,\n      desiredVisibility,\n      handleBackButtonPress,\n      handleBackdropPress,\n      handleModalShown,\n      handleModalHidden,\n      param,\n      visibility,\n    }),\n    [\n      confirm,\n      cancel,\n      desiredVisibility,\n      handleBackButtonPress,\n      handleBackdropPress,\n      handleModalShown,\n      handleModalHidden,\n      param,\n      visibility,\n    ]\n  );\n};\n"]}